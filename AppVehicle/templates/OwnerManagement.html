{% extends "master.html" %}
{% load static %}
{% load urlify %}
{% load humanize %}

{% block title %}Owner Management{% endblock %}

{% block PluginsCSS %}
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/jquery.dataTables.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/select.bootstrap5.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/sweetalert2.css" %}">
{% endblock %}

{% block breadcrumb %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <h3>Owner Management System</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="index">
                                <svg class="stroke-icon">
                                    <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                                </svg>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Vehicle</li>
                        <li class="breadcrumb-item active">Owner Management</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}

    <!-- Container-fluid starts-->
    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-12">
                <div class="common-f-start justify-content-md-end mb-3">
                    <div class="btn-group btn-group-action">
                        <button class="btn btn-primary btn-md" onclick="Cred_Owner_ShowModel('NEW');">
                            <i class="fa fa-plus"></i> Add New Owner
                            <span class="loading-spinner" id="loadingSpinner"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row user-list-wrapper">
            <div class="col-12">

                <div class="card">
                    <style>
                        .user-list-wrapper .user-list-table div.dt-container .dt-layout-row .dt-search {
                            right: 20px;
                        }
                    </style>
                    <div class="card-header card-no-border text-end pb-5"></div>
                    <div class="card-body pt-0 px-0">
                        <div class="list-product user-list-table recent-table task-table">
                            <div class="table-responsive custom-scrollbar ">
                                <table class="table" id="container-list">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th><span class="c-o-light f-w-600">Owner Code</span></th>
                                        <th><span class="c-o-light f-w-600">Name</span></th>
                                        <th><span class="c-o-light f-w-600">CNIC</span></th>
                                        <th><span class="c-o-light f-w-600">Phone</span></th>
                                        <th><span class="c-o-light f-w-600">Address</span></th>
                                        <th><span class="c-o-light f-w-600">Type</span></th>
                                        <th><span class="c-o-light f-w-600">Status</span></th>
                                        <th><span class="c-o-light f-w-600">Actions</span></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for owner in owners %}
                                        <tr class="product-removes inbox-data">
                                            <td>{{ forloop.counter }}</td>
                                            <td><a href="javaScript:void(0)">{{ owner.owner_code }}</a></td>
                                            <td><p>{{ owner.name }}</p></td>
                                            <td><p>{{ owner.cnic }}</p></td>
                                            <td><p>{{ owner.phone_number }}</p></td>
                                            <td><p>{{ owner.address|truncatechars:30 }}</p></td>
                                            <td><p>{{ owner.owner_type }}</p></td>
                                            <td>
                                                {% if owner.status == 'Active' %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Blocked</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="common-align gap-2 justify-content-start">
                                                    <a class="square-white" href="javaScript:void(0)"
                                                       onclick="Cred_Owner_ShowModel('UPDATE,{{ owner.id }},{{ owner.owner_code }},{{ owner.name }},{{ owner.cnic }},{{ owner.phone_number }},{{ owner.address }},{{ owner.owner_type }},{{ owner.status }}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#edit-content"></use>
                                                        </svg>
                                                    </a>
                                                    <a class="square-white trash-8" href="javaScript:void(0)"
                                                       onclick="Cred_Owner_ShowModel('DELETED,{{ owner.id }}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#trash1"></use>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block PluginsJS %}

    <script src="{% static "assets/js/datatable/datatables/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.select.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/select.bootstrap5.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/datatable.custom.js" %}"></script>
    <script src="{% static "assets/js/sweet-alert/sweetalert.min.js" %}"></script>
    <script src="{% static "assets/js/trash_popup.js" %}"></script>
    <script src="{% static "assets/js/common-check.js" %}"></script>

{% endblock %}

{% block CustomerJS %}
    <script>

        $(document).ready(function () {

            {% if messages %}
                {% for message in messages %}
                    UtilityModelJS.ToastSweetAlert("top-center", "success", "{{ message }}");
                {% endfor %}
            {% endif %}

        });

        function Cred_Owner_ShowModel(params) {

            var split = params.split(",");

            let action_type = split[0];
            let unique_id = "";
            let set_owner_code = "";
            let set_name = "";
            let set_cnic = "";
            let set_phone_number = "";
            let set_address = "";
            let set_owner_type = "Self";
            let set_status = "Active";

            if (action_type === "UPDATE") {
                unique_id = split[1];
                set_owner_code = split[2];
                set_name = split[3];
                set_cnic = split[4];
                set_phone_number = split[5];
                set_address = split[6];
                set_owner_type = split[7];
                set_status = split[8];
            } else if (action_type === "DELETED") {
                unique_id = split[1];

                const deleteIcons = document.querySelectorAll(".trash-8");
                deleteIcons.forEach(function (icon) {
                    icon.addEventListener("click", function (event) {
                        event.preventDefault();
                        let alertMessage = "Do you really want to delete this owner?";

                        Swal.fire({
                            title: "Are you sure?",
                            text: alertMessage,
                            showCancelButton: true,
                            confirmButtonColor: "#16C7F9",
                            cancelButtonColor: "#FC4438",
                            confirmButtonText: "Yes, delete it!",
                            imageUrl: "/static/assets/images/gif/trash.gif",
                            imageWidth: 120,
                            imageHeight: 120,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $("#ownerForm").submit(); // manually submit form
                            }
                        });
                    });
                });

            }

            $("#effect-modal-header").empty();
            $("#effect-modal-header").append('<h6 class="modal-title text-capitalize" id="set_title">Add New Owner</h6>' +
                '<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">' +
                '<span aria-hidden="true">×</span></button>');

            $("#effect-modal-body").html("");
            var container_body = $("#effect-modal-body");
            container_body.append('<form id="ownerForm" method="post" action="">' +   // action="" means same URL
                '{% csrf_token %}' +
                '<div class="row g-3 p-3 mb-3">' +
                "<input type='hidden' id='action_type' name='action_type' value='" + action_type + "' autocomplete='off'>" +
                "<input type='hidden' id='unique_id' name='unique_id' value='" + unique_id + "' autocomplete='off'>" +
                '<div class="col-12">' +
                (action_type === "UPDATE"
                ? '<div class="col-12">' +
                '<label for="owner_code" class="form-label">Owner Code</label>' +
                "<input type='text' name='owner_code' id='owner_code' value='" + set_owner_code + "' class='form-control' readonly></div>"
                : "") +
                '<label for="name" class="form-label">Full Name</label>' +
                "<input type='text' name='name' id='name' value='" + set_name + "' class='form-control' placeholder='Enter full name' required ></div>" +
                '<div class="col-12">' +
                '<label for="cnic" class="form-label">CNIC</label>' +
                "<input type='text' name='cnic' id='cnic' value='" + set_cnic + "' class='form-control' placeholder='00000-0000000-0' pattern='[0-9]{5}-[0-9]{7}-[0-9]{1}' required ></div>" +
                '<div class="col-12">' +
                '<label for="phone_number" class="form-label">Phone Number</label>' +
                "<input type='text' name='phone_number' id='phone_number' value='" + set_phone_number + "' class='form-control' placeholder='03XX-XXXXXXX' ></div>" +
                '<div class="col-12">' +
                '<label for="address" class="form-label">Address</label>' +
                "<textarea name='address' id='address' class='form-control' placeholder='Enter address' rows='3'>" + set_address + "</textarea></div>" +
                '<div class="col-12">' +
                '<label for="owner_type" class="form-label">Owner Type</label>' +
                '<select name="owner_type" id="owner_type" class="form-select">' +
                '<option value="Self">Self</option>' +
                '<option value="Vendor">Vendor</option>' +
                '</select></div>' +
                '<div class="col-12">' +
                '<label for="status" class="form-label">Status</label>' +
                '<select name="status" id="status" class="form-select">' +
                '<option value="Active">Active</option>' +
                '<option value="Block">Block</option>' +
                '</select></div>' +
                '</div>' +
                '</form>'
            );

            // Set dropdown values
            $("#owner_type").val(set_owner_type);
            $("#status").val(set_status);

            $("#effect-modal-footer").html("");
            var container_footer = $("#effect-modal-footer");
            container_footer.append('<button class="btn btn-sm w-50 btn-success" type="button" id="submitBtn">Save Owner</button>' +
                '<button class="btn btn-sm w-25 btn-danger" data-bs-dismiss="modal" type="button">Close</button>');

            if (action_type !== "DELETED") {
                $('#effectModal').modal('show');
            }

            //// FORM VALIDATION (START)
            $("#submitBtn").click(function () {
                let Status = 0;

                // Basic validation
                if ($('#name').val().trim() === '') {
                    alert('Please enter full name');
                    return;
                }
                if ($('#cnic').val().trim() === '') {
                    alert('Please enter CNIC');
                    return;
                }

                if (Status === 0) {
                    $("#ownerForm").submit(); // Submit the form
                }
            });
            //// FORM VALIDATION (END)

            // Format CNIC input
            $('#cnic').on('input', function() {
                var numericInput = $(this).val().replace(/[^\d]/g, '');
                var cnic = '';
                if (numericInput.length > 0) {
                    cnic = numericInput.substring(0, 5);
                    if (numericInput.length > 5) {
                        cnic += '-' + numericInput.substring(5, 12);
                        if (numericInput.length > 12) {
                            cnic += '-' + numericInput.substring(12, 13);
                        }
                    }
                }
                $(this).val(cnic);
            });

            // Format phone number input
            $('#phone_number').on('input', function() {
                var numericInput = $(this).val().replace(/[^\d]/g, '');
                var phone = '';
                if (numericInput.length > 0) {
                    phone = numericInput.substring(0, 4);
                    if (numericInput.length > 4) {
                        phone += '-' + numericInput.substring(4);
                    }
                }
                $(this).val(phone);
            });

        }

    </script>
{% endblock %}