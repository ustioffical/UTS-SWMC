{% extends "master.html" %}
{% load static %}

{% block title %}Report{% endblock %}

<!-- Custom Plugins CSS -->
{% block PluginsCSS %}
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/jquery.dataTables.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/select.bootstrap5.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/sweetalert2.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/select/bootstrap-select.min.css' %}">
{% endblock %}
<!--End Custom Plugins CSS -->

{% block LeafletLink %}
    <!--Google Key-->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyN4NVgaHV6-AbuAdWqSBM07iay6gbfKc&libraries=places"></script>
    <!--leaflet js library style link -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <link rel="stylesheet"
          href="{% static 'assets/script/jslib/leaflet/plugins/PolylineMeasure/Leaflet.PolylineMeasure.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'assets/script/jslib/leaflet/plugins/styledLayerControl/styledLayerControl.css' %}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
{% endblock %}

{% block link %}
    <link rel="stylesheet" type="text/css" href="{% static 'assets/app_css/GetColor-Tooltip-Vehicle.css' %}">
{% endblock %}

{% block css %}
    .default-map-js-height{
    height: 725px;
    }
    .filter-companies .accordion-item {
    border: 1px solid #e9edf1;
    }
    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li a svg {
    width: 24px;
    height: 24px;
    }
    .border-tb-l-radius {
    border-top-left-radius: 5px !important;
    border-bottom-left-radius: 5px !important;
    }
    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li {
    margin-bottom: 10px;
    }
    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li a {
    padding: 6px 10px
    }
    .common-space {
    justify-content: normal;
    }
    .course-box .card-body {
    padding: 10px 15px;
    }
    .form-select {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    border: 1px solid #e9edf1;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-select:focus {
    border-color: #7366ff;
    box-shadow: 0 0 0 0.2rem rgba(115, 102, 255, 0.25);
    }
    .form-label.fw-bold {
    font-size: 0.875rem;
    color: #2c323f;
    }
    .custom-select-lg {
    height: calc(1.5em + 1rem + 2px);
    font-size: 0.875rem;
    }
    .filter-cards-view .accordion-body {
    padding: 1rem;
    background-color: #fff;
    }
    .filter-cards-view .card-body {
    padding: 1.25rem;
    }
    .btn-hover-effect:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
    }
    .small-view-link {
    display: block;
    font-size: 12px;
    color: #7366ff;
    text-decoration: none;
    margin-top: 3px;
    }

    .small-view-link:after {
    content: " â†’";
    }

    .small-view-link:hover {
    color: #5145cc;
    }

    .course-box {
    transition: all 0.3s ease;
    border-radius: 8px;
    overflow: hidden;
    }

    .course-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .course-icon {
    transition: all 0.3s ease;
    }

    .course-box:hover .course-icon {
    transform: scale(1.1);
    }

    .filter-active {
    border: 2px solid #7366ff !important;
    box-shadow: 0 0 8px rgba(115, 102, 255, 0.5) !important;
    }
{% endblock %}

<!-- Header Page Hierarchy-->
{% block breadcrumb %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <h3>Vehicle Trip</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/index">
                            <svg class="stroke-icon">
                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                            </svg>
                        </a></li>
                        <li class="breadcrumb-item">Report</li>
                        <li class="breadcrumb-item active">Vehicle-Trip</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
<!-- Header Page Hierarchy-->

{% block content %}

    <!-- Container-fluid starts-->
    <div class="container-fluid main-companies">

        <div class="row">

            <div class="col-xl-5 xl-6 box-col-12">

                <div class="row general-widget-wrapper">
                    <div class="col-12">
                        <div class="d-flex flex-row justify-content-between gap-3">
                            <!-- Total Vehicle Box -->
                            <div class="card course-box flex-fill cursor-pointer" id="filter-all"
                                 onclick="filterVehicles('all')">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="course-icon bg-primary rounded-circle p-2"
                                             style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                            <svg class="fill-icon text-white" width="22" height="22">
                                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-progress-delivery"></use>
                                            </svg>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <h4 class="mb-0 fs-5">{{ vehicle_count }}</h4>
                                            <span class="f-light">Total Vehicle</span>
                                        </div>
                                    </div>
                                </div>
                                <ul class="square-group">
                                    <li class="square-1 warning"></li>
                                    <li class="square-1 primary"></li>
                                    <li class="square-2 warning1"></li>
                                    <li class="square-3 danger"></li>
                                </ul>
                            </div>

                            <!-- Distance > 20km Box -->
                            <div class="card course-box flex-fill cursor-pointer" id="filter-greater20"
                                 onclick="filterVehicles('greater20')">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="course-icon bg-success rounded-circle p-2"
                                             style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                            <svg class="fill-icon text-white" width="22" height="22">
                                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#chart-line"></use>
                                            </svg>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <h4 class="mb-0 fs-5">{{ vehicle_distance_greater_than_20km_count }}</h4>
                                            <span class="f-light">Distance > 20</span>
                                        </div>
                                    </div>
                                </div>
                                <ul class="square-group">
                                    <li class="square-1 success"></li>
                                    <li class="square-1 primary"></li>
                                    <li class="square-2 warning1"></li>
                                </ul>
                            </div>

                            <!-- Distance < 20km Box -->
                            <div class="card course-box flex-fill cursor-pointer" id="filter-less20"
                                 onclick="filterVehicles('less20')">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="course-icon bg-warning rounded-circle p-2"
                                             style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                            <svg class="fill-icon text-white" width="22" height="22">
                                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#course-2"></use>
                                            </svg>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <h4 class="mb-0 fs-5">{{ vehicle_distance_less_than_20km_count }}</h4>
                                            <span class="f-light">Distance < 20</span>
                                        </div>
                                    </div>
                                </div>
                                <ul class="square-group">
                                    <li class="square-1 warning"></li>
                                    <li class="square-1 primary"></li>
                                    <li class="square-2 danger"></li>
                                </ul>
                            </div>

                            <!-- Distance < 5km Box -->
                            <div class="card course-box flex-fill cursor-pointer" id="filter-less5"
                                 onclick="filterVehicles('less5')">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="course-icon bg-danger rounded-circle p-2"
                                             style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                            <svg class="fill-icon text-white" width="22" height="22">
                                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-calendar"></use>
                                            </svg>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <h4 class="mb-0 fs-5">{{ vehicle_distance_less_than_5km_count }}</h4>
                                            <span class="f-light">Distance < 5</span>
                                        </div>
                                    </div>
                                </div>
                                <ul class="square-group">
                                    <li class="square-1 danger"></li>
                                    <li class="square-1 primary"></li>
                                    <li class="square-2 warning"></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="md-sidebar"><a class="btn btn-primary email-aside-toggle md-sidebar-toggle">Filters</a>
                        <div class="md-sidebar-aside job-sidebar custom-scrollbar">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Trip Analysis</h5>
                                </div>
                                <div class="card-body filter-companies">

                                    <div class="accordion" id="accordionExample">

                                        LAYER INFORMATION
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button"
                                                        data-bs-toggle="collapse" data-bs-target="#collapseLayer"
                                                        aria-expanded="true" aria-controls="collapseLayer">
                                                    Layer Information
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="feather feather-chevron-down svg-color">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </button>
                                            </h2>
                                            <div class="accordion-collapse collapse" id="collapseLayer" style="">
                                                <div class="accordion-body">
                                                    <!-- Layer Information Content -->
                                                    <div class="col-xl-12 box-col-12 pe-0 xl-12 main-file-sidebar">
                                                        <!-- Layer controls content here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- LAYER INFORMATION -->

                                        <!-- FILTER INFORMATION -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseFilter" aria-expanded="true"
                                                        aria-controls="collapseFilter">
                                                    Filter
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="feather feather-chevron-down svg-color">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </button>
                                            </h2>
                                            <div class="accordion-collapse" id="collapseFilter" style="">
                                                <div class="accordion-body">
                                                    <div class="card-body filter-cards-view animate-chk">

                                                        <form class="form form-horizontal" action=""
                                                              method="post" accept-charset='utf-8'
                                                              enctype="multipart/form-data">

                                                            {% csrf_token %}
                                                            <div class="job-filter">
                                                                <div class="faq-form">
                                                                    <input class="form-control" type="text"
                                                                           placeholder="Search By Vehicle ID...">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                         height="24" viewBox="0 0 24 24" fill="none"
                                                                         stroke="currentColor" stroke-width="2"
                                                                         stroke-linecap="round" stroke-linejoin="round"
                                                                         class="feather feather-map-pin search-icon">
                                                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                                                        <circle cx="12" cy="10" r="3"></circle>
                                                                    </svg>
                                                                </div>
                                                            </div>

                                                            <div class="row mb-3">
                                                                <label class="col-md-4 form-label pt-1 fw-bolder">
                                                                    Select Vehicle Type:
                                                                </label>
                                                                <div class="col-md-8">
                                                                    <select id="cmd_vehicle_type"
                                                                            name="cmd_vehicle_type"
                                                                            class="selectpicker"
                                                                            data-live-search="true">
                                                                        <option value="NA"
                                                                                {% if filtered_vehicle_type == None or filtered_vehicle_type == 'NA' %}selected{% endif %}>
                                                                            Choose One
                                                                        </option>
                                                                        {% for type in vehicle_type_list %}
                                                                            <option value="{{ type.vehicle_type }}"
                                                                                    {% if filtered_vehicle_type == type.vehicle_type %}selected{% endif %}>
                                                                                {{ type.vehicle_type }}
                                                                                - {{ type.count }}
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>

                                                                </div>
                                                            </div>

                                                            <div class="row mb-3">
                                                                <label class="col-md-4 form-label fw-bolder pt-1">
                                                                    Select Vehicle ID:
                                                                </label>
                                                                <div class="col-md-8">
                                                                    <select id="cmd_vehicle_list"
                                                                            name="cmd_vehicle_list"
                                                                            class="selectpicker" data-live-search="true"
                                                                            data-size="10">
                                                                        <option value="NA"
                                                                                {% if filtered_vehicle_id == None or filtered_vehicle_id == 'NA' %}selected{% endif %}>
                                                                            Choose One
                                                                        </option>
                                                                        {% for vehicle_id in vehicle_ids %}
                                                                            <option value="{{ vehicle_id }}"
                                                                                    {% if filtered_vehicle_id == vehicle_id %}selected{% endif %}>{{ vehicle_id }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>

                                                            <div class="mb-3 row">
                                                                <label class="col-md-4 col-form-label fw-bolder">
                                                                    Start Date-Time
                                                                </label>
                                                                <div class="col-md-8">
                                                                    <input class="form-control digits"
                                                                           id="from_datetime"
                                                                           name="from_datetime"
                                                                           type="datetime-local"
                                                                           value="{{ from_datetime|default:'' }}">
                                                                </div>
                                                            </div>

                                                            <div class="mb-3 row">
                                                                <label class="col-md-4 col-form-label fw-bolder">End
                                                                    Date-Time</label>
                                                                <div class="col-md-8">

                                                                    <input class="form-control digits"
                                                                           id="to_datetime"
                                                                           name="to_datetime"
                                                                           type="datetime-local"
                                                                           value="{{ to_datetime|default:'' }}">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="m-t-15 btn-showcase d-flex gap-2  mt-3 justify-content-end">
                                                                    <button class="btn btn-success btn-hover-effect"
                                                                            type="submit">
                                                                        <i class="fa-solid fa-search me-1"></i>
                                                                        Apply Filter
                                                                    </button>
                                                                </div>
                                                            </div>

                                                        </form>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- FILTER INFORMATION -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-7 xl-66 box-col-12">
                <div class="card">
                    <div class="card-body z-1 p-0">
                        <div class="default-map-js-height b-r-10" id="create-container-map"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 user-list-wrapper">
                <div class="card">
                    <style>
                        .user-list-wrapper .user-list-table div.dt-container .dt-layout-row .dt-search {
                            right: 20px;
                        }
                    </style>
                    <div class="card-header card-no-border text-end pb-5">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 id="filtered-title">All Vehicles</h5>
                            <div>
                                <span class="badge bg-primary mb-2 me-2" id="filtered-count">{{ vehicle_count }} vehicles</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0 px-0">
                        <div class="list-product user-list-table recent-table task-table">
                            <div class="table-responsive custom-scrollbar ">
                                <table class="table" id="vehicle-list">
                                    <thead>
                                    <tr>
                                        <th><span class="c-o-light f-w-600">#</span></th>
                                        <th><span class="c-o-light f-w-600">Vehicle ID</span></th>
                                        <th><span class="c-o-light f-w-600">Register No.</span></th>
                                        <th><span class="c-o-light f-w-600">Type</span></th>
                                        <th><span class="c-o-light f-w-600">Distance (km)</span></th>
                                    </tr>
                                    </thead>
                                    <tbody class="main-task-wrapper">
                                    {% for data in vehicle_data_obj %}
                                        <tr class="product-removes inbox-data"
                                            data-distance="{{ data.line_length_km }}">
                                            <th scope="row" class="xsm-text text-capitalize align-middle">
                                                {{ forloop.counter }}
                                            </th>
                                            <td>
                                                <p><b>{{ data.vehicle_code }}</b></p>
                                            </td>
                                            <td>
                                                <p><b>{{ data.register_no }}</b></p>
                                            </td>
                                            <td>
                                                <p>{{ data.vehicle_type }}</p>
                                            </td>
                                            <td>
                                                <p class="p-b-0" style="line-height: 1;">Kilometer:
                                                    <b>{{ data.line_length_km }}</b>
                                                </p>
                                                <p class="p-b-0" style="line-height: 1;">Meter:
                                                    <b>{{ data.line_length_m }}</b>
                                                </p>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Container-fluid Ends-->

{% endblock %}

<!-- Plugins JS start-->
{% block PluginsJS %}
    <script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'assets/js/datatable/datatables/dataTables.js' %}"></script>
    <script src="{% static 'assets/js/datatable/datatables/dataTables.select.js' %}"></script>
    <script src="{% static 'assets/js/datatable/datatables/select.bootstrap5.js' %}"></script>
    <script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
    <script src="{% static 'assets/js/sweet-alert/sweetalert.min.js' %}"></script>
    <script src="{% static 'assets/js/flat-pickr/flatpickr.js' %}"></script>
    <script src="{% static 'assets/js/flat-pickr/custom-flatpickr.js' %}"></script>
    <script src="{% static 'assets/js/select/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'assets/js/tooltip-init.js' %}"></script>
{% endblock %}
<!-- Plugins JS Ends-->

{% block LeafletJS %}
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/GoogleMutant/Leaflet.GoogleMutant.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/measure/L.MeasuringTool.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/PolylineMeasure/Leaflet.PolylineMeasure.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/styledLayerControl/styledLayerControl.js' %}"></script>
    <!-- Dependency to Leaflet Draw -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/Editable/Leaflet.Editable.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/Snap/leaflet.geometryutil.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/Snap/leaflet.snap.js' %}"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
{% endblock %}

<!-- Custom JS -->
{% block CustomerJS %}
    <script src="{% static 'assets/script/include/DigitalArz.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/script/include/TOCLayerModel.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/app_js/VehicleModel.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/app_js/ReportModel.js' %}" type="text/javascript"></script>
    <script>
        // Initialize global variables for the various modules
        let DigitalArzModelJS = null;
        let TOCLayerModelJS = null;
        let ReportModelJS = null;
        let VehicleModelJS = null;
        let me = {}; // Object for storing helper functions
        // Define URLs for AJAX calls
        const fetch_single_vehicle_trip_history_data = "/vehicle/fetch-single-vehicle-trip-history/";

        // Function to filter vehicles based on distance ranges
        function filterVehicles(filterType) {
            // Reset all filter card styling
            document.querySelectorAll('.course-box').forEach(box => {
                box.classList.remove('filter-active');
            });

            // Add active style to the clicked filter
            document.getElementById('filter-' + filterType).classList.add('filter-active');

            // Get DataTable instance
            let table = $('#vehicle-list').DataTable();

            // Clear any existing filters
            table.search('').columns().search('').draw();

            // Remove any previous custom filter
            $.fn.dataTable.ext.search.pop();

            if (filterType !== 'all') {
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    // Get the row element and read the data-distance attribute directly
                    let row = table.row(dataIndex).node();
                    let distance = parseFloat($(row).attr('data-distance'));

                    // Make sure we have a valid number
                    if (isNaN(distance)) {
                        return false;
                    }

                    // Apply filtering based on the selected filter type
                    switch (filterType) {
                        case 'greater20':
                            return distance >= 20;
                        case 'less20':
                            return distance < 20 && distance >= 5; // Between 5 and 20
                        case 'less5':
                            return distance < 5;
                        default:
                            return true;
                    }
                });
            }

            // Apply the filter and redraw the table
            table.draw();

            // Update filter title and count based on filter type
            let visibleCount = table.rows({search: 'applied'}).count();
            let filterTitle = 'All Vehicles';

            switch (filterType) {
                case 'greater20':
                    filterTitle = 'Vehicles with Distance > 20 km';
                    break;
                case 'less20':
                    filterTitle = 'Vehicles with Distance < 20 km';
                    break;
                case 'less5':
                    filterTitle = 'Vehicles with Distance < 5 km';
                    break;
            }

            document.getElementById('filtered-title').textContent = filterTitle;
            document.getElementById('filtered-count').textContent = visibleCount + ' vehicles';

            // Smooth scroll to the table for better UX
            document.getElementById('vehicle-list').scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        // Helper function for AJAX calls
        function callAJAX(params, callback) {
            $.ajax({
                url: params.url,
                data: params.data,
                type: params.type,
                dataType: params.dataType,
                processData: false,
                contentType: false,
                headers: params.headers,
                success: callback,
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", error);
                }
            });
        }

        // Get icon URL based on vehicle status
        me.GetImage_IconUrl_VehicleTrip = function (pick_status, vehicle_status, veh_speed, veh_direction) {
            let iconPath = '/static/assets/images/legend/';
            if (pick_status === "START") {
                return iconPath + 'start-icon.png';
            } else if (pick_status === "FINISH") {
                return iconPath + 'finish-icon.png';
            } else {
                return iconPath + 'vehicle-icon.png';
            }
        };

        // Generate polyline for vehicle trip
        me.GeneratePolyline_VehicleTrip_Speed = function (CoordinateOBJ, VehicleSpeed) {
            if (CoordinateOBJ.length > 1) {
                let polyline = L.polyline(CoordinateOBJ, {
                    color: 'blue',
                    weight: 3,
                    opacity: 0.7
                });
                DigitalArzModelJS.GroupRouteNetworkLayer.addLayer(polyline);
            }
        };

        {#// Simplified function to retrieve vehicle trip history#}
        {#me.RetrieveSingleVehicleHistoryTrip = function (vehicle_id, start_date, end_date) {#}
        {#    // Clear previous route data#}
        {#    DigitalArzModelJS.IndicatorFeature.clearLayers();#}
        {#    DigitalArzModelJS.GroupRouteNetworkLayer.clearLayers();#}
        {##}
        {#    // Call the VehicleModelJS function to fetch and display the trip data#}
        {#    VehicleModelJS.FetchSingleVehicleTripHistoryDataView(vehicle_id, start_date, end_date);#}
        {#    setTimeout(function () {#}
        {#        location.reload();#}
        {#    }, 1500); // 1.5 seconds delay before reload#}
        {# };#}

        // Document ready function - initialize components
        $(document).ready(function () {
            // Check if DataTable already exists and destroy it if it does
            if ($.fn.DataTable.isDataTable('#vehicle-list')) {
                $('#vehicle-list').DataTable().destroy();
            }

            // Initialize DataTable with proper configuration
            let vehicleTable = $('#vehicle-list').DataTable({
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [],
                "createdRow": function (row, data, dataIndex) {
                    // Store the distance value as a data attribute on the row element
                    // First, extract the distance from the 5th column of the row
                    // This is assuming the distance is in the format "Kilometer: X.XX"
                    let distanceText = data[4]; // 5th column (0-based index)
                    let distanceMatch = distanceText.match(/Kilometer:\s*<b>(\d+\.?\d*)<\/b>/);
                    let distance = distanceMatch ? parseFloat(distanceMatch[1]) : 0;
                    $(row).attr('data-distance', distance);
                },
                "drawCallback": function () {
                    // Update counter after table is redrawn
                    let visibleCount = this.api().rows({search: 'applied'}).count();
                    $('#filtered-count').text(visibleCount + ' vehicles');
                }
            });

            // Apply initial filter
            filterVehicles('all');

            // Initialize other components
            ReportModelJS = new AppReportModel();
            ReportModelJS.appConstructor("VehicleHistory");

            VehicleModelJS = new AppVehicleModel();
            VehicleModelJS.appConstructor();

            // Initialize map
            DigitalArzModelJS = new AppDigitalArzModel("create-container-map");
            if (DigitalArzModelJS.map === null) {
                DigitalArzModelJS.LoadMap("true", "");
                TOCLayerModelJS = new AppTOCLayerModel();
                TOCLayerModelJS.appConstructor();
                TOCLayerModelJS.FetchVehicleFeatureData("Onload", vehicle_live_lists);
            }

            // Vehicle type dropdown change event
            $("#cmd_vehicle_type").change(function (e) {
                let selected_value = e.target.value;
                VehicleModelJS.VehicleListWithTypeCodeView("cmd_vehicle_list", selected_value, "None", "");
            });

            // Set initial datetime values for the form
            let now = new Date();
            let today = now.toISOString().split('T')[0];

            // Set default date/time values if not already set
            if (!$('#from_datetime').val()) {
                $('#from_datetime').val(today + 'T08:00');
            }

            if (!$('#to_datetime').val()) {
                $('#to_datetime').val(today + 'T18:00');
            }

            // Form submission handling
            $('form').on('submit', function (e) {
                e.preventDefault();

                // Get form values
                let vehicle_id = $('#cmd_vehicle_list').val();
                let start_date = $('#from_datetime').val();
                let end_date = $('#to_datetime').val();

                // Validate required inputs
                if (vehicle_id === 'NA' || vehicle_id === '') {
                    alert('Please select a specific vehicle ID to view trip history');
                    return;
                }

                if (start_date === '' || end_date === '') {
                    alert('Please select both start and end date-time');
                    return;
                }

                // Convert to proper format for backend
                let startDateTime = start_date.replace('T', ' ');
                let endDateTime = end_date.replace('T', ' ');

                // Update trip vehicle and date in the summary
                $('#trip-vehicle').text(vehicle_id);
                $('#trip-date').text(startDateTime + ' to ' + endDateTime);

                // Call the trip history function with the validated parameters
                me.RetrieveSingleVehicleHistoryTrip(vehicle_id, startDateTime, endDateTime);
            });
        });
    </script>
{% endblock %}
<!-- End Custom JS -->