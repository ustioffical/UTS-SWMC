{% extends "master.html" %}
{% load static %}
{% load urlify %}
{% load humanize %}

{% block title %}Vehicle Driver Assignment{% endblock %}

{% block PluginsCSS %}
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/jquery.dataTables.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/select.bootstrap5.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/sweetalert2.css" %}">
    <!-- Add Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block breadcrumb %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <h3>Vehicle Driver Assignment System</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="index">
                                <svg class="stroke-icon">
                                    <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                                </svg>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Vehicle</li>
                        <li class="breadcrumb-item active">Driver Assignment</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}

    <!-- Container-fluid starts-->
    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-12">
                <div class="common-f-start justify-content-md-end mb-3">
                    <div class="btn-group btn-group-action">
                        <button class="btn btn-primary btn-md" onclick="Cred_VehicleDriverAssignment_ShowModel('NEW');">
                            <i class="fa fa-plus"></i> Add New Assignment
                            <span class="loading-spinner" id="loadingSpinner"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row user-list-wrapper">
            <div class="col-12">

                <div class="card">
                    <style>
                        .user-list-wrapper .user-list-table div.dt-container .dt-layout-row .dt-search {
                            right: 20px;
                        }
                        /* Custom Select2 styling */
                        .select2-container--bootstrap-5 .select2-selection {
                            min-height: calc(1.5em + 0.75rem + 2px);
                            padding: 0.375rem 0.75rem;
                            font-size: 1rem;
                            border-radius: 0.25rem;
                        }
                        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
                            padding-left: 0;
                            padding-right: 0;
                            height: auto;
                            margin-top: 0;
                        }
                        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
                            height: calc(1.5em + 0.75rem);
                            right: 0.75rem;
                        }
                    </style>
                    <div class="card-header card-no-border text-end pb-5"></div>
                    <div class="card-body pt-0 px-0">
                        <div class="list-product user-list-table recent-table task-table">
                            <div class="table-responsive custom-scrollbar ">
                                <table class="table" id="container-list">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th><span class="c-o-light f-w-600">Vehicle</span></th>
                                        <th><span class="c-o-light f-w-600">Driver</span></th>
                                        <th><span class="c-o-light f-w-600">Start Date</span></th>
                                        <th><span class="c-o-light f-w-600">End Date</span></th>
                                        <th><span class="c-o-light f-w-600">Status</span></th>
                                        <th><span class="c-o-light f-w-600">Actions</span></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for assignment in vehicle_driver_data %}
                                        <tr class="product-removes inbox-data">
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <a href="javaScript:void(0)">
                                                    <strong>{{ assignment.vehicle_code.vehicle_code }}</strong><br>
                                                    <small class="text-muted">{{ assignment.vehicle_code.register_no }}</small>
                                                </a>
                                            </td>
                                            <td>
                                                <p>
                                                    <strong>{{ assignment.driver_code.driver_code }}</strong><br>
                                                    <small class="text-muted">{{ assignment.driver_code.name }}</small>
                                                </p>
                                            </td>
                                            <td>{{ assignment.start_date|date:"Y-m-d" }}</td>
                                            <td>
                                                {% if assignment.end_date %}
                                                    {{ assignment.end_date|date:"Y-m-d" }}
                                                {% else %}
                                                    <span class="text-muted">Ongoing</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if assignment.end_date %}
                                                    {% if assignment.end_date < today_date %}
                                                        <span class="badge bg-secondary">Completed</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Active</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-success">Active</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="common-align gap-2 justify-content-start">
                                                    <a class="square-white" href="javaScript:void(0)"
                                                       onclick="Cred_VehicleDriverAssignment_ShowModel('UPDATE,{{ assignment.id }},{{ assignment.vehicle_code.vehicle_code }},{{ assignment.driver_code.driver_code }},{{ assignment.start_date|date:"Y-m-d" }},{% if assignment.end_date %}{{ assignment.end_date|date:"Y-m-d" }}{% endif %}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#edit-content"></use>
                                                        </svg>
                                                    </a>
                                                    <a class="square-white trash-8" href="javaScript:void(0)"
                                                       onclick="Cred_VehicleDriverAssignment_ShowModel('DELETED,{{ assignment.id }}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#trash1"></use>
                                                        </svg>
                                                    </a>
                                                    {% if assignment.driver_phone %}
                                                        <a class="square-white" href="tel:{{ assignment.driver_phone }}">
                                                            <svg>
                                                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#call"></use>
                                                            </svg>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block PluginsJS %}

    <script src="{% static "assets/js/datatable/datatables/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.select.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/select.bootstrap5.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/datatable.custom.js" %}"></script>
    <script src="{% static "assets/js/sweet-alert/sweetalert.min.js" %}"></script>
    <script src="{% static "assets/js/trash_popup.js" %}"></script>
    <script src="{% static "assets/js/common-check.js" %}"></script>
    <!-- Add Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{% endblock %}

{% block CustomerJS %}
    <script>

        $(document).ready(function () {

            {% if messages %}
                {% for message in messages %}
                    {% if message.tags == 'error' %}
                        UtilityModelJS.ToastSweetAlert("top-center", "error", "{{ message }}");
                    {% else %}
                        UtilityModelJS.ToastSweetAlert("top-center", "success", "{{ message }}");
                    {% endif %}
                {% endfor %}
            {% endif %}

        });

        function Cred_VehicleDriverAssignment_ShowModel(params) {

            var split = params.split(",");

            let action_type = split[0];
            let unique_id = "";
            let set_vehicle_code = "";
            let set_driver_code = "";
            let set_start_date = "";
            let set_end_date = "";

            if (action_type === "UPDATE") {
                unique_id = split[1];
                set_vehicle_code = split[2];
                set_driver_code = split[3];
                set_start_date = split[4];
                set_end_date = split[5] || "";
            } else if (action_type === "DELETED") {
                unique_id = split[1];

                const deleteIcons = document.querySelectorAll(".trash-8");
                deleteIcons.forEach(function (icon) {
                    icon.addEventListener("click", function (event) {
                        event.preventDefault();
                        let alertMessage = "Do you really want to delete this assignment?";

                        Swal.fire({
                            title: "Are you sure?",
                            text: alertMessage,
                            showCancelButton: true,
                            confirmButtonColor: "#16C7F9",
                            cancelButtonColor: "#FC4438",
                            confirmButtonText: "Yes, delete it!",
                            imageUrl: "/static/assets/images/gif/trash.gif",
                            imageWidth: 120,
                            imageHeight: 120,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $("#vehicleDriverAssignmentForm").submit();
                            }
                        });
                    });
                });

            }

            $("#effect-modal-header").empty();
            $("#effect-modal-header").append('<h6 class="modal-title text-capitalize" id="set_title">Vehicle Driver Assignment Manager</h6>' +
                '<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">' +
                '<span aria-hidden="true">×</span></button>');

            $("#effect-modal-body").html("");
            var container_body = $("#effect-modal-body");

            // Build vehicle options
            var vehicleOptions = '<option value="">Select Vehicle</option>';
            {% for vehicle_code, register_no in vehicle_code_list %}
                vehicleOptions += '<option value="{{ vehicle_code }}">{{ vehicle_code }} - {{ register_no }}</option>';
            {% endfor %}

            // Build driver options
            var driverOptions = '<option value="">Select Driver</option>';
            {% for driver_code, name in driver_code_list %}
                driverOptions += '<option value="{{ driver_code }}">{{ driver_code }} - {{ name }}</option>';
            {% endfor %}

            container_body.append('<form id="vehicleDriverAssignmentForm" method="post" action="">' +
                '{% csrf_token %}' +
                '<div class="row g-3 p-3 mb-3">' +
                "<input type='hidden' id='action_type' name='action_type' value='" + action_type + "' autocomplete='off'>" +
                "<input type='hidden' id='unique_id' name='unique_id' value='" + unique_id + "' autocomplete='off'>" +
                '<div class="col-12">' +
                '<label for="vehicle_code" class="form-label">Vehicle Code</label>' +
                '<select name="vehicle_code" id="vehicle_code" class="form-select searchable-select" required>' +
                vehicleOptions +
                '</select></div>' +
                '<div class="col-12">' +
                '<label for="driver_code" class="form-label">Driver</label>' +
                '<select name="driver_code" id="driver_code" class="form-select searchable-select" required>' +
                driverOptions +
                '</select></div>' +
                '<div class="col-6">' +
                '<label for="start_date" class="form-label">Start Date</label>' +
                "<input type='date' name='start_date' id='start_date' value='" + set_start_date + "' class='form-control' required ></div>" +
                '<div class="col-6">' +
                '<label for="end_date" class="form-label">End Date (Optional)</label>' +
                "<input type='date' name='end_date' id='end_date' value='" + set_end_date + "' class='form-control' ></div>" +
                '<div class="col-12">' +
                '<small class="form-text text-muted">Leave end date empty for ongoing assignment</small>' +
                '</div>' +
                '</div>' +
                '</form>'
            );

            // Initialize Select2 for searchable dropdowns after DOM is ready
            setTimeout(function() {
                // Initialize vehicle dropdown
                $('#vehicle_code').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search and select vehicle...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#effect-modal-body'),
                    language: {
                        noResults: function() {
                            return "No vehicles found";
                        },
                        searching: function() {
                            return "Searching vehicles...";
                        }
                    }
                });

                // Initialize driver dropdown
                $('#driver_code').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search and select driver...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#effect-modal-body'),
                    language: {
                        noResults: function() {
                            return "No drivers found";
                        },
                        searching: function() {
                            return "Searching drivers...";
                        }
                    }
                });

                // Set values after Select2 initialization
                if (set_vehicle_code) {
                    console.log("Setting vehicle code:", set_vehicle_code);
                    $("#vehicle_code").val(set_vehicle_code).trigger('change');
                }
                if (set_driver_code) {
                    console.log("Setting driver code:", set_driver_code);
                    $("#driver_code").val(set_driver_code).trigger('change');
                }

                // Additional fallback to ensure values are set properly
                setTimeout(function() {
                    if (set_vehicle_code && $("#vehicle_code").val() !== set_vehicle_code) {
                        console.log("Fallback: Setting vehicle code again:", set_vehicle_code);
                        $("#vehicle_code").val(set_vehicle_code).trigger('change');
                    }
                    if (set_driver_code && $("#driver_code").val() !== set_driver_code) {
                        console.log("Fallback: Setting driver code again:", set_driver_code);
                        $("#driver_code").val(set_driver_code).trigger('change');
                    }
                }, 300);

            }, 100);

            $("#effect-modal-footer").html("");
            var container_footer = $("#effect-modal-footer");
            container_footer.append('<button class="btn btn-sm w-50 btn-success" type="button" id="submitBtn">Save Assignment</button>' +
                '<button class="btn btn-sm w-25 btn-danger" data-bs-dismiss="modal" type="button">Close</button>');

            if (action_type !== "DELETED") {
                $('#effectModal').modal('show');
            }

            // Form validation and submission
            $("#submitBtn").click(function () {
                let Status = 0;

                // Basic validation
                if (!$("#vehicle_code").val()) {
                    UtilityModelJS.ToastSweetAlert("top-center", "error", "Please select a vehicle");
                    Status = 1;
                }

                if (!$("#driver_code").val()) {
                    UtilityModelJS.ToastSweetAlert("top-center", "error", "Please select a driver");
                    Status = 1;
                }

                if (!$("#start_date").val()) {
                    UtilityModelJS.ToastSweetAlert("top-center", "error", "Please select start date");
                    Status = 1;
                }

                // Check if end date is before start date
                var startDate = $("#start_date").val();
                var endDate = $("#end_date").val();

                if (startDate && endDate && endDate < startDate) {
                    UtilityModelJS.ToastSweetAlert("top-center", "error", "End date cannot be before start date");
                    Status = 1;
                }

                if (Status === 0) {
                    $("#vehicleDriverAssignmentForm").submit();
                }
            });

            // Clean up Select2 when modal is closed
            $('#effectModal').on('hidden.bs.modal', function () {
                if ($('#vehicle_code').hasClass('select2-hidden-accessible')) {
                    $('#vehicle_code').select2('destroy');
                }
                if ($('#driver_code').hasClass('select2-hidden-accessible')) {
                    $('#driver_code').select2('destroy');
                }
            });

        }

    </script>
{% endblock %}