{% extends "master.html" %}
{% load static %}
{% load urlify %}
{% load humanize %}

{% block title %}Driver Management{% endblock %}

{% block PluginsCSS %}
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/jquery.dataTables.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/select.bootstrap5.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/sweetalert2.css" %}">
{% endblock %}

{% block breadcrumb %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <h3>Driver Management System</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="index">
                                <svg class="stroke-icon">
                                    <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                                </svg>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Vehicle</li>
                        <li class="breadcrumb-item active">Driver Management</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}

    <!-- Container-fluid starts-->
    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-12">
                <div class="common-f-start justify-content-md-end mb-3">
                    <div class="btn-group btn-group-action">
                        <button class="btn btn-primary btn-md" onclick="Cred_Driver_ShowModel('NEW');">
                            <i class="fa fa-plus"></i> Add New Driver
                            <span class="loading-spinner" id="loadingSpinner"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row user-list-wrapper">
            <div class="col-12">

                <div class="card">
                    <style>
                        .user-list-wrapper .user-list-table div.dt-container .dt-layout-row .dt-search {
                            right: 20px;
                        }
                        .license-expiry-warning {
                            color: #ff4500;
                            font-weight: bold;
                        }
                    </style>
                    <div class="card-header card-no-border text-end pb-5"></div>
                    <div class="card-body pt-0 px-0">
                        <div class="list-product user-list-table recent-table task-table">
                            <div class="table-responsive custom-scrollbar ">
                                <table class="table" id="container-list">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th><span class="c-o-light f-w-600">Driver Code</span></th>
                                        <th><span class="c-o-light f-w-600">Name</span></th>
                                        <th><span class="c-o-light f-w-600">CNIC</span></th>
                                        <th><span class="c-o-light f-w-600">License No</span></th>
                                        <th><span class="c-o-light f-w-600">License Expiry</span></th>
                                        <th><span class="c-o-light f-w-600">Phone</span></th>
                                        <th><span class="c-o-light f-w-600">Actions</span></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for driver in drivers_data %}
                                        <tr class="product-removes inbox-data">
                                            <td>{{ forloop.counter }}</td>
                                            <td><a href="javaScript:void(0)">{{ driver.driver_code }}</a></td>
                                            <td><p>{{ driver.name }}</p></td>
                                            <td><p>{{ driver.cnic }}</p></td>
                                            <td><p>{{ driver.license_no }}</p></td>
                                            <td {% if driver.license_expiry|date:'Y-m-d' < today_date|date:'Y-m-d' %}class="license-expiry-warning"{% endif %}>
                                                {{ driver.license_expiry|date:"M d, Y" }}
                                            </td>
                                            <td><p>{{ driver.phone_number }}</p></td>
                                            <td>
                                                <div class="common-align gap-2 justify-content-start">
                                                    <a class="square-white" href="javaScript:void(0)"
                                                       onclick="Cred_Driver_ShowModel('UPDATE,{{ driver.id }},{{ driver.name }},{{ driver.cnic }},{{ driver.license_no }},{{ driver.license_expiry|date:'Y-m-d' }},{{ driver.phone_number }}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#edit-content"></use>
                                                        </svg>
                                                    </a>
                                                    <a class="square-white trash-8" href="javaScript:void(0)"
                                                       onclick="Cred_Driver_ShowModel('DELETED,{{ driver.id }}');">
                                                        <svg>
                                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#trash1"></use>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block PluginsJS %}

    <script src="{% static "assets/js/datatable/datatables/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.select.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/select.bootstrap5.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/datatable.custom.js" %}"></script>
    <script src="{% static "assets/js/sweet-alert/sweetalert.min.js" %}"></script>
    <script src="{% static "assets/js/trash_popup.js" %}"></script>
    <script src="{% static "assets/js/common-check.js" %}"></script>

{% endblock %}

{% block CustomerJS %}
    <script>

        $(document).ready(function () {

            {% if messages %}
                {% for message in messages %}
                    UtilityModelJS.ToastSweetAlert("top-center", "success", "{{ message }}");
                {% endfor %}
            {% endif %}

        });

        function Cred_Driver_ShowModel(params) {

            var split = params.split(",");

            let action_type = split[0];
            let unique_id = "";
            let set_name = "";
            let set_cnic = "";
            let set_license_no = "";
            let set_license_expiry = "";
            let set_phone_number = "";

            if (action_type === "UPDATE") {
                unique_id = split[1];
                set_name = split[2];
                set_cnic = split[3];
                set_license_no = split[4];
                set_license_expiry = split[5];
                set_phone_number = split[6];
            } else if (action_type === "DELETED") {
                unique_id = split[1];

                const deleteIcons = document.querySelectorAll(".trash-8");
                deleteIcons.forEach(function (icon) {
                    icon.addEventListener("click", function (event) {
                        event.preventDefault();
                        let alertMessage = "Do you really want to delete this driver?";

                        Swal.fire({
                            title: "Are you sure?",
                            text: alertMessage,
                            showCancelButton: true,
                            confirmButtonColor: "#16C7F9",
                            cancelButtonColor: "#FC4438",
                            confirmButtonText: "Yes, delete it!",
                            imageUrl: "/static/assets/images/gif/trash.gif",
                            imageWidth: 120,
                            imageHeight: 120,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $("#driverForm").submit(); // manually submit form
                            }
                        });
                    });
                });

            }

            $("#effect-modal-header").empty();
            $("#effect-modal-header").append('<h6 class="modal-title text-capitalize" id="set_title">Add New Driver</h6>' +
                '<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">' +
                '<span aria-hidden="true">×</span></button>');

            $("#effect-modal-body").html("");
            var container_body = $("#effect-modal-body");
            container_body.append('<form id="driverForm" method="post" action="">' +   // action="" means same URL
                '{% csrf_token %}' +
                '<div class="row g-3 p-3 mb-3">' +
                "<input type='hidden' id='action_type' name='action_type' value='" + action_type + "' autocomplete='off'>" +
                "<input type='hidden' id='unique_id' name='unique_id' value='" + unique_id + "' autocomplete='off'>" +
                '<div class="col-12">' +
                '<label for="name" class="form-label">Full Name</label>' +
                "<input type='text' name='name' id='name' value='" + set_name + "' class='form-control' placeholder='Enter full name' required ></div>" +
                '<div class="col-12">' +
                '<label for="cnic" class="form-label">CNIC</label>' +
                "<input type='text' name='cnic' id='cnic' value='" + set_cnic + "' class='form-control' placeholder='00000-0000000-0' pattern='[0-9]{5}-[0-9]{7}-[0-9]{1}' required ></div>" +
                '<div class="col-12">' +
                '<label for="license_no" class="form-label">License Number</label>' +
                "<input type='text' name='license_no' id='license_no' value='" + set_license_no + "' class='form-control' placeholder='Enter license number' required ></div>" +
                '<div class="col-12">' +
                '<label for="license_expiry" class="form-label">License Expiry Date</label>' +
                "<input type='date' name='license_expiry' id='license_expiry' value='" + set_license_expiry + "' class='form-control' required ></div>" +
                '<div class="col-12">' +
                '<label for="phone_number" class="form-label">Phone Number</label>' +
                "<input type='text' name='phone_number' id='phone_number' value='" + set_phone_number + "' class='form-control' placeholder='03XX-XXXXXXX' ></div>" +
                '</div>' +
                '</form>'
            );

            $("#effect-modal-footer").html("");
            var container_footer = $("#effect-modal-footer");
            container_footer.append('<button class="btn btn-sm w-50 btn-success" type="button" id="submitBtn">Save Driver</button>' +
                '<button class="btn btn-sm w-25 btn-danger" data-bs-dismiss="modal" type="button">Close</button>');

            if (action_type !== "DELETED") {
                $('#effectModal').modal('show');
            }

            //// FORM VALIDATION (START)
            $("#submitBtn").click(function () {
                let Status = 0;

                // Basic validation
                if ($('#name').val().trim() === '') {
                    alert('Please enter full name');
                    return;
                }
                if ($('#cnic').val().trim() === '') {
                    alert('Please enter CNIC');
                    return;
                }
                if ($('#license_no').val().trim() === '') {
                    alert('Please enter license number');
                    return;
                }
                if ($('#license_expiry').val().trim() === '') {
                    alert('Please select license expiry date');
                    return;
                }

                if (Status === 0) {
                    $("#driverForm").submit(); // Submit the form
                }
            });
            //// FORM VALIDATION (END)

            // Format CNIC input
            $('#cnic').on('input', function() {
                var numericInput = $(this).val().replace(/[^\d]/g, '');
                var cnic = '';
                if (numericInput.length > 0) {
                    cnic = numericInput.substring(0, 5);
                    if (numericInput.length > 5) {
                        cnic += '-' + numericInput.substring(5, 12);
                        if (numericInput.length > 12) {
                            cnic += '-' + numericInput.substring(12, 13);
                        }
                    }
                }
                $(this).val(cnic);
            });

            // Format phone number input
            $('#phone_number').on('input', function() {
                var numericInput = $(this).val().replace(/[^\d]/g, '');
                var phone = '';
                if (numericInput.length > 0) {
                    phone = numericInput.substring(0, 4);
                    if (numericInput.length > 4) {
                        phone += '-' + numericInput.substring(4);
                    }
                }
                $(this).val(phone);
            });

        }

    </script>
{% endblock %}