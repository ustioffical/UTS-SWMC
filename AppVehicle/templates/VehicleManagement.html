{% extends "master.html" %}
{% load static %}

{% block title %}Vehicle Management{% endblock %}

<!-- Custom Plugins CSS -->
{% block PluginsCSS %}
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/jquery.dataTables.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/select.bootstrap5.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/sweetalert2.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "assets/css/vendors/select/bootstrap-select.min.css" %}">
{% endblock %}
<!--End Custom Plugins CSS -->

{% block LeafletLink %}
    <!--Google Key-->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyN4NVgaHV6-AbuAdWqSBM07iay6gbfKc&libraries=places"></script>

    <!--leaflet js library style link -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <link rel="stylesheet"
          href="{% static 'assets/script/jslib/leaflet/plugins/PolylineMeasure/Leaflet.PolylineMeasure.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'assets/script/jslib/leaflet/plugins/styledLayerControl/styledLayerControl.css' %}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
{% endblock %}

{% block link %}
    <link rel="stylesheet" type="text/css" href="{% static "assets/app_css/GetColor-Tooltip-Vehicle.css" %}">
{% endblock %}

{% block css %}

    .default-map-js-height{
    height: 605px;
    }

    .filter-companies .accordion-item {
    border: 1px solid #e9edf1;
    }

    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li a svg {
    width: 24px;
    height: 24px;
    }

    .border-tb-l-radius {
    border-top-left-radius: 5px !important;
    border-bottom-left-radius: 5px !important;
    }

    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li {
    margin-bottom: 10px;
    }

    .main-file-sidebar .md-sidebar .md-sidebar-aside .common-sort-card .files-left-icons li a {
    padding: 6px 10px
    }

    .common-space {
    justify-content: normal;
    }

    .course-box .card-body {
    padding: 10px 15px;
    }

    .status-badge i {
    margin-right: 5px;
    }

    .status-working {
    background-color: #28a745;
    color: white;
    }

    .status-delay {
    background-color: #ffc107;
    color: #212529;
    }

    .status-no-response {
    background-color: #6c757d;
    color:Â white;
    }

    .btn-connect {
    margin-top: 5px;
    margin-left: 12px;
    width: 120px;
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
    }
    .btn-connect:hover{
    background-color:rgb(8, 96, 190) !important;
    color: white !important;
    }

{% endblock %}

<!-- Header Page Hierarchy-->
{% block breadcrumb %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    {#        <h3>{{breadcrumb.title}} </h3>#}
                    <h3>Vehicle Management</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/index">
                            <svg class="stroke-icon">
                                <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                            </svg>
                        </a></li>
                        {#          <li class="breadcrumb-item">{{breadcrumb.parent}}</li>#}
                        <li class="breadcrumb-item">Vehicle</li>
                        <li class="breadcrumb-item active">Management</li>
                        {#          <li class="breadcrumb-item active">{{breadcrumb.child}}</li>#}
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
<!-- Header Page Hierarchy-->

{% block content %}
    <div class="container-fluid main-companies">

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">

                        <form class="form form-horizontal" action=""
                              method="post" accept-charset='utf-8'
                              enctype="multipart/form-data">

                            {% csrf_token %}

                            <div class="row g-3 align-items-end">

                                <div class="col-xl col-md-2">
                                    <label class="form-label">Vehicle With Type</label>
                                    <select id="cmd_vehicle_type"
                                            name="cmd_vehicle_type"
                                            class="selectpicker"
                                            data-live-search="true">
                                        <option value="NA" selected>Choose One</option>
                                        {% for type in vehicle_type_list %}
                                            <option value="{{ type.vehicle_type }}"
                                                    {% if type.vehicle_type == selected_vehicle_type %}selected{% endif %}>
                                                {{ type.vehicle_type }}
                                                - {{ type.count }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-xl col-md-2">
                                    <label class="form-label">Device Status</label>
                                    <select id="cmd_device_status"
                                            name="cmd_device_status"
                                            class="selectpicker"
                                            data-live-search="true">
                                        {% for value, label in device_status %}
                                            <option value="{{ value }}"
                                                    {% if value == selected_device_status %}selected{% endif %}>{{ label }} </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {#                                <div class="col-md-2">#}
                                {#                                    <label class="form-label" for="device_status">Device Status:</label>#}
                                {#                                    <select class="form-select" name="device_status" id="device_status">#}
                                {#                                        <option value="all"#}
                                {#                                                {% if request.GET.device_status == "all" or not request.GET.device_status %}selected{% endif %}>#}
                                {#                                            All#}
                                {#                                        </option>#}
                                {#                                        <option value="working"#}
                                {#                                                {% if request.GET.device_status == "working" %}selected{% endif %}>#}
                                {#                                            Working#}
                                {#                                        </option>#}
                                {#                                        <option value="not_responded"#}
                                {#                                                {% if request.GET.device_status == "not_responded" %}selected{% endif %}>#}
                                {#                                            Not Responded#}
                                {#                                        </option>#}
                                {#                                    </select>#}
                                {#                                </div>#}

                                <div class="col-xl col-md-2">
                                    <label class="form-label">Vehicle Status</label>
                                    <select id="cmd_vehicle_status"
                                            name="cmd_vehicle_status"
                                            class="selectpicker"
                                            data-live-search="true">
                                        <option value="NA" selected>Choose One</option>

                                        {% for status, value in working_status_options %}
                                            <option value="{{ status }}"
                                                    {% if status == selected_status %}selected{% endif %}>{{ status }}
                                                - {{ value }}</option>
                                        {% endfor %}

                                        {% for status, value in no_response_options %}
                                            <option value="{{ status }}"
                                                    {% if status == selected_status %}selected{% endif %}>{{ status }}
                                                - {{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {#                                <div class="col-md-2">#}
                                {#                                    <label class="form-label" for="g_status">Vehicle Status:</label>#}
                                {#                                    <select class="form-select" name="g_status" id="g_status">#}
                                {#                                        <option value="">All</option>#}
                                {#                                        <!-- Options will be populated dynamically -->#}
                                {#                                    </select>#}
                                {#                                </div>#}
                                {#                            chart_data#}
                                <div class="col-xl col-md-2">
                                    <label class="form-label">Vehicle Name</label>
                                    <select id="cmd_vehicle_list"
                                            name="cmd_vehicle_list"
                                            class="selectpicker"
                                            data-live-search="true">
                                        <option value="NA" selected>Choose One</option>
                                        {% for vehicle in vehicle_codes %}
                                            <option value="{{ vehicle.vehicle_code }}"
                                                    {% if selected_vehicle_code == vehicle.vehicle_code %}selected{% endif %}>
                                                {{ vehicle.register_no }}
                                                ({{ vehicle.pitb_code }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {#                                <div class="col-md-2">#}
                                {#                                    <label for="startDate" class="form-label">Start Date</label>#}
                                {#                                    <input type="date" class="form-control" id="startDate" name="start_date"#}
                                {#                                           value="{{ start_date|date:'Y-m-d' }}" required>#}
                                {#                                </div>#}
                                {#                                <div class="col-md-2">#}
                                {#                                    <label for="endDate" class="form-label">End Date</label>#}
                                {#                                    <input type="date" class="form-control" id="endDate" name="end_date"#}
                                {#                                           value="{{ end_date|date:'Y-m-d' }}" required>#}
                                {#                                </div>#}
                                <div class="col-md-2 d-flex align-items-center justify-content-center">
                                    <button type="submit" class="btn btn-primary me-2">Filter</button>
                                    {% comment %} <button type="button" id="resetFilter" class="btn btn-secondary">Reset</button> {% endcomment %}
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>

        <!-- Timer Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="h5">Auto Refresh: </span>
                                <span id="timer" class="h5 text-primary">02:00</span>
                            </div>
                            <div>
                                <button id="stopTimer" class="btn btn-danger">
                                    <i class="fa fa-stop"></i> Stop
                                </button>
                                <button id="resumeTimer" class="btn btn-success" style="display: none;">
                                    <i class="fa fa-play"></i> Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie Chart Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <div class="row d-flex justify-content-around">
                        <div class="col-md-6">
                            <div><h5>Working Vehicles</h5></div>
                            <div id="currentVehicleCount">Total Vehicles : {{ all_vehicles_today_count }} out
                                of {{ total_vehicles_count }}</div>
                        </div>
                        <div class="col-md-6 text-end px-3">
                            <div id="lastSyncTime">Last Sync : {{ last_sync_time }}</div>
                        </div>
                    </div>
                    <div id="gStatusPieChart" style="height: 400px;"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <div class="row d-flex justify-content-around">
                        <div class="col-md-6">
                            <div><h5>Not Responsed Vehicles</h5></div>
                            <div id="nr_vehciles_count">Total Vehicles : {{ vendor_date_groups_count }} out
                                of {{ total_vehicles_count }}</div>
                        </div>
                        <div class="col-md-6 text-end px-3">
                            <div id="lastSyncTime2">Last Sync : {{ last_sync_time }}</div>
                            <a class="btn btn-danger" href="{% url "no-response-vehicle" %}">NR Vehicles {{vendor_date_groups_count}}</a>
                        </div>
                    </div>
                    <div id="vendorDatePieChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- Vehicles Table -->
        <div class="row candidate-wrapper">
            <div class="col-12">
                <div class="card">
                    <div class="card-body candidates-box px-0">
                        <div class="table-responsive custom-scrollbar">
                            <table class="table" id="vehicle-monitoring-table">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Vehicle</th>
                                    <th>Vehicle Type</th>
                                    <th>Push Time</th>
                                    <th>Delay Time</th>
                                    <th>Status</th>
                                    <th>NR</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody id="tbody_vehicle_status_datatable">
                                {% if current_vehicles %}
                                    {% for data in current_vehicles %}
                                        <tr>
                                            <th scope="row">{{ forloop.counter }}</th>
                                            <td>
                                                <div class="common-flex align-items-center">
                                                    <div class="position-relative">
                                                        <img class="img-fluid rounded-circle"
                                                             src="{% static 'assets/images/legend/vehicle/vehicle.png' %}"
                                                             alt="user">
                                                        <div class="status" style="width: 15px; height: 15px;">
                                                            <div class="inner-dot bg-{% if data.vehicle.g_status == "Moving" %}success{% elif data.vehicle.g_status == "Idle" %}info{% elif data.vehicle.g_status == "Parked" %}warning{% elif data.vehicle.g_status == "Offline" %}light{% else %}danger{% endif %}"></div>
                                                        </div>
                                                    </div>
                                                    <div><a class="f-w-500"
                                                            href="#!">Reg# {{ data.vehicle.vehicle_code.pitb_code }}
                                                        - {{ data.vehicle.vehicle_code.register_no }}</a>
                                                        <p>Chasis# {{ data.vehicle.vehicle_code.chasis_no }}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="common-f-start">
                                                    <div class="attachment">
                                                        <i class="fa-solid fa-car"></i>
                                                        <span>{{ data.vehicle.vehicle_code.vehicle_type }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <ul class="educations">
                                                    <li>
                                                        <p class="mb-0">
                                                            {% if data.vendor_date_time %}
                                                                {{ data.vendor_date_time |date:"M j, Y, g:i A" }}
                                                            {% else %}
                                                                <span class="text-warning">No Live Data</span>
                                                            {% endif %}
                                                        </p>
                                                    </li>
                                                </ul>
                                            </td>
                                            <td>
                                                <ul class="candidate-skill">
                                                    <li>
                                                        {% if data.delay_time %}
                                                            <span class="badge badge-light-primary">{{ data.delay_time|floatformat:2 }}h</span>
                                                        {% else %}
                                                            <span class="badge badge-light-success">-</span>
                                                        {% endif %}
                                                    </li>
                                                </ul>
                                            </td>
                                            <td>
                                                <ul class="candidate-skill">
                                                    <li>
                                                        <p class="mb-2">Device Status :
                                                            <span>{{ data.device_status }}</span>
                                                        </p>
                                                    </li>
                                                    <li>
                                                        <div class="common-flex">
                                                            <span class="badge badge-light-primary">{{ data.ignition_status }}</span>
                                                            <span class="badge badge-light-warning">{{ data.g_status }}</span>
                                                            <span class="badge badge-light-success">{{ data.speed }}</span>
                                                            <span class="badge badge-light-secondary">{{ data.duration }}</span>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </td>
                                            {% comment %} <td>{{ data.from_off }}</td>
                                            <td>{{ data.till_off }}</td> {% endcomment %}
                                            <td>
                                                {% if data.is_current %}
                                                    <span class="badge badge-light-success">Active</span>
                                                {% else %}
                                                    <span class="badge badge-light-danger">NR: {{ data.nr_days }} Day
                                                        {% if data.nr_days != 1 %}s{% endif %}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="col-md-12">
                                                    <div class="upper-btn">
                                                        <button class="btn btn-info" data-bs-toggle="tooltip"
                                                                title="Map"
                                                                onclick="openMapModal('{{ data.latitude }}', '{{ data.longitude }}')">
                                                            <i class="fa-solid fa-map-location-dot"></i>
                                                        </button>
                                                        <button class="btn btn-warning" data-bs-toggle="tooltip"
                                                                title="Complain"
                                                                onclick="window.location.href='/SWMC/Vehicle/create-complaint-form/{{ data.vehicle.vehicle_code.vehicle_code }}'">
                                                            <i class="fa-solid fa-triangle-exclamation"></i>
                                                        </button>
                                                        <button class="btn btn-dark" data-bs-toggle="tooltip"
                                                                title="Report"
                                                                onclick="window.location.href='{% url 'SingleVehicleGeoStatusMovementReport' data.vehicle.vehicle_code.vehicle_code %}?start_date={{ start_date_report|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}'">
                                                            <i class="fa-solid fa-file-lines"></i>
                                                        </button>
                                                    </div>
                                                    {% if data.delay_time %}
                                                        <div class="row connect-btn">
                                                            <button type="button" class="btn btn-action btn-connect"
                                                                    onclick="connectVehicle('{{ data.vehicle.vehicle_code.vehicle_code|default:'N/A' }}')"
                                                                    title="Connect to Vehicle">
                                                                <i class="fa fa-link me-1"></i>Connect
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        No Vehicles Found
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Vehicle Modal -->
    <div class="modal fade" id="connectVehicleModal" tabindex="-1" aria-labelledby="connectVehicleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectVehicleModalLabel">
                        <i class="fa fa-link me-2"></i>Connect Vehicle to Route
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="connectVehicleContent">
                    <form id="connectVehicleForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="connect_vehicle_code" class="form-label">Vehicle Code</label>
                            <input type="text" class="form-control" id="connect_vehicle_code" name="vehicle_code"
                                   readonly>
                        </div>
                        <div class="mb-3">
                            <label for="connect_pitb_code" class="form-label">PITB Code <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="connect_pitb_code" name="pitb_code"
                                   placeholder="Enter PITB Code" required>
                        </div>
                        <div id="alert-container"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmConnect">
                        <i class="fa fa-link me-2"></i>Connect
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

{% endblock %}

<!-- Plugins JS start-->
{% block PluginsJS %}

    <script src="{% static "assets/js/datatable/datatables/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/dataTables.select.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/select.bootstrap5.js" %}"></script>
    <script src="{% static "assets/js/datatable/datatables/datatable.custom.js" %}"></script>
    <script src="{% static "assets/js/sweet-alert/sweetalert.min.js" %}"></script>

    <script src="{% static "assets/js/flat-pickr/flatpickr.js" %}"></script>
    <script src="{% static "assets/js/flat-pickr/custom-flatpickr.js" %}"></script>
    <script src="{% static "assets/js/select/bootstrap-select.min.js" %}"></script>
    <script src="{% static "assets/js/tooltip-init.js" %}"></script>

{% endblock %}
<!-- Plugins JS Ends-->


{% block LeafletJS %}
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/GoogleMutant/Leaflet.GoogleMutant.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/measure/L.MeasuringTool.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/PolylineMeasure/Leaflet.PolylineMeasure.js' %}"></script>
    <script src="{% static 'assets/script/jslib/leaflet/plugins/styledLayerControl/styledLayerControl.js' %}"></script>
    <!-- Dependency to Leaflet Draw -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>
    <script src="{% static "assets/script/jslib/leaflet/plugins/Editable/Leaflet.Editable.js" %}"></script>
    <script src="{% static "assets/script/jslib/leaflet/plugins/Snap/leaflet.geometryutil.js" %}"></script>
    <script src="{% static "assets/script/jslib/leaflet/plugins/Snap/leaflet.snap.js" %}"></script>

    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

{% endblock %}


{% block CustomerJS %}
    <script>
        $(document).ready(function () {
            $('.selectpicker').selectpicker();

            // Get the chart data from the server
            const chartData = JSON.parse('{{ chart_data|escapejs }}');
            console.log(chartData);

            // Function to sort days
            function sortDays(days) {
                return Object.entries(days).sort((a, b) => {
                    // Extract numbers from strings like "1 Day" or "65 Days"
                    const numA = parseInt(a[0].split(' ')[0]);
                    const numB = parseInt(b[0].split(' ')[0]);
                    return numA - numB;
                });
            }

            $("#cmd_device_status").change(function (e) {
                let selected_value = e.target.value;

                if (selected_value === 'working') {
                } else if (selected_value === 'not_responded') {
                } else {

                }

            });


            // Timer functionality
            let timeLeft = 120; // 2 minutes in seconds
            let timerId = null;
            let isTimerStopped = false;

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                $('#timer').text(
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                );
            }

            function startTimer() {
                if (timerId) return; // Prevent multiple timers

                timerId = setInterval(() => {
                    if (timeLeft <= 0) {
                        // Reset timer and reload page
                        clearInterval(timerId);
                        timeLeft = 120;
                        location.reload();
                        return;
                    }
                    timeLeft--;
                    updateTimerDisplay();
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerId);
                timerId = null;
                isTimerStopped = true;
                $('#stopTimer').hide();
                $('#resumeTimer').show();
            }

            function resumeTimer() {
                isTimerStopped = false;
                $('#resumeTimer').hide();
                $('#stopTimer').show();
                startTimer();
            }

            // Event listeners for timer controls
            $('#stopTimer').click(stopTimer);
            $('#resumeTimer').click(resumeTimer);

            // Start timer initially
            startTimer();

            // Handle page visibility changes
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    // Page is hidden, stop the timer
                    if (timerId) {
                        stopTimer();
                    }
                } else {
                    // Page is visible again, resume timer if it wasn't manually stopped
                    if (!isTimerStopped) {
                        resumeTimer();
                    }
                }
            });
        });

        function openMapModal(lat, lon) {
            alert("Open map for location: " + lat + ", " + lon);
        }

    </script>

    <!-- Highcharts CDN -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script>
        const chartData = JSON.parse('{{ chart_data|escapejs }}');
        let gStatusChart, vendorDateChart;

        function getStatusClass(status) {
            switch (status) {
                case "Moving":
                    return "success";
                case "Idle":
                    return "info";
                case "Parked":
                    return "warning";
                case "Offline":
                    return "light";
                default:
                    return "danger";
            }
        }

        // Initialize charts
        gStatusChart = Highcharts.chart('gStatusPieChart', {
            chart: {type: 'pie'},
            title: {text: ''},
            plotOptions: {
                pie: {
                    innerSize: '60%',
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}: {point.y} vehicles'
                    },
                    point: {
                        events: {
                            click: function () {
                                filterByGStatus(this.name);
                            }
                        }
                    }
                }
            },
            tooltip: {pointFormat: '{series.name}: <b>{point.y}</b> vehicles'},
            series: [{
                name: 'Vehicles',
                colorByPoint: true,
                data: Object.entries(chartData.current_working).map(([name, value]) => ({name, y: value}))
            }]
        });

        vendorDateChart = Highcharts.chart('vendorDatePieChart', {
            chart: {type: 'pie'},
            title: {text: ''},
            plotOptions: {
                pie: {
                    innerSize: '60%',
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}: {point.y} vehicles'
                    },
                    point: {
                        events: {
                            click: function () {
                                filterByVendorDays(this.name);
                            }
                        }
                    }
                }
            },
            tooltip: {pointFormat: '{series.name}: <b>{point.y}</b> vehicles'},
            series: [{
                name: 'Vehicles',
                colorByPoint: true,
                data: Object.entries(chartData.no_responsed).map(([name, value]) => ({name, y: value}))
            }]
        });

        // Connect vehicle function
        function connectVehicle(vehicleCode) {
            // Set the vehicle code in the form
            $('#connect_vehicle_code').val(vehicleCode);
            $('#connect_pitb_code').val('');
            $('#alert-container').html('');

            // Show the modal
            $('#connectVehicleModal').modal('show');
        }

        // Handle connect form submission
        $('#confirmConnect').click(function () {
            var vehicleCode = $('#connect_vehicle_code').val();
            var pitbCode = $('#connect_pitb_code').val().trim();
            var button = $(this);

            // Validate PITB code
            if (!pitbCode) {
                showAlert('danger', 'Please enter a PITB code.');
                return;
            }

            // Disable button and show loading
            button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin me-2"></i>Connecting...');

            // Connect vehicle (includes PITB check)
            $.ajax({
                url: '{% url "connect_vehicle_to_route" %}',
                method: 'POST',
                data: {
                    'vehicle_code': vehicleCode,
                    'pitb_code': pitbCode,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showAlert('success', response.message + ' Page will reload in 2 minutes.');

                        // Close modal and reload page after 2 minutes (120000ms)
                        setTimeout(function () {
                            $('#connectVehicleModal').modal('hide');
                            setTimeout(function () {
                                location.reload();
                            }, 119000); // Wait another 119 seconds after closing modal
                        }, 1000);
                    } else {
                        showAlert('danger', response.message);
                        button.prop('disabled', false).html('<i class="fa fa-link me-2"></i>Connect');
                    }
                },
                error: function () {
                    showAlert('danger', 'Error connecting vehicle to route. Please try again.');
                    button.prop('disabled', false).html('<i class="fa fa-link me-2"></i>Connect');
                }
            });
        });


        // Function to show alerts in the modal
        function showAlert(type, message) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
            $('#alert-container').html(alertHtml);
        }
    </script>

{% endblock %}