{% extends "master.html" %}
{% load static %}

{% block title %}Create Vehicle Complaint{% endblock %}

<!-- Keep the breadcrumb section the same -->
{% block breadcrumb %}
<!-- ...existing code... -->
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                  {% if not existing_complaint %}
                    <h5>Submit New Vehicle Complaint</h5>
                  {% endif %}
                </div>
                <div class="card-body">
                    {% if existing_complaint %}
                        <!-- Show existing complaint message and redirect -->
                        <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Existing Complaint Found</h5>
                </div>
                <div class="card-body text-center py-4">
                    <div class="mb-4">
                        <i class="fas fa-info-circle fa-4x text-info mb-3"></i>
                        <h4 class="fw-bold">Complaint Already Exists</h4>
                        <p class="text-muted">A complaint for this vehicle was already submitted today.</p>
                    </div>

                    <div class="alert alert-warning text-start">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-circle me-2 mt-1"></i>
                            <div>
                                <h6 class="fw-bold mb-1">Complaint Details:</h6>
                                <p class="mb-1"><strong>Complaint #:</strong> {{ existing_complaint.complaint_code }}</p>
                                <p class="mb-1"><strong>Type:</strong> {{ existing_complaint.complaint_type }}</p>
                                <p class="mb-1"><strong>Status:</strong>
                                    <span class="badge
                                        {% if existing_complaint.status == 'Open' %}bg-warning
                                        {% elif existing_complaint.status == 'In Progress' %}bg-info
                                        {% elif existing_complaint.status == 'Resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ existing_complaint.status }}
                                    </span>
                                </p>
                                <p class="mb-0"><strong>Date:</strong> {{ existing_complaint.created_at|date:"M d, Y H:i" }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                        <a href="{% url 'status' %}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-arrow-left me-1"></i> Back to Status
                        </a>
                        <a href="{% url 'getspecificcomplaint' existing_complaint.complaint_code %}" class="btn btn-primary">
                            <i class="fas fa-eye me-1"></i> View Full Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
                    {% else %}
                        <!-- Complaint form -->
                        <form id="complaintForm" action="{% url 'create_complaint_form' vehicle_code %}" method="post">
                            {% csrf_token %}

                            <div class="mb-3 row">
                                <label for="vehicle_code" class="col-sm-3 col-form-label">Vehicle Code:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="vehicle_code" name="vehicle_code"
                                           value="{{ vehicle_code }}" readonly>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="complaint_type" class="col-sm-3 col-form-label">Complaint Type:</label>
                                <div class="col-sm-9">
                                    <select class="form-select" id="complaint_type" name="complaint_type" required>
                                        <option value="" selected disabled>Select a complaint type</option>
                                        <option value="Device Issue">Device Issue</option>
                                        <option value="GPS Not Working">GPS Not Working</option>
                                        <option value="Data Not Reporting">Data Not Reporting</option>
                                        <option value="Battery Issue">Battery Issue</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="description" class="col-sm-3 col-form-label">Description:</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="description" name="description"
                                              rows="5" required placeholder="Describe the issue in detail..."></textarea>
                                </div>
                            </div>

                            <div class="text-end">
                            <a href="{% url 'AllVehicleManagement' %}" class="btn btn-light me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <span class="spinner-border spinner-border-sm me-1 d-none" id="submitSpinner" role="status" aria-hidden="true"></span>
                                Submit Complaint
                            </button>
                        </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Success</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Complaint submitted successfully!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="redirectBtn">Continue</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}